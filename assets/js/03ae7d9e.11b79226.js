(window.webpackJsonp=window.webpackJsonp||[]).push([[5],{67:function(e,n,t){"use strict";t.r(n),t.d(n,"frontMatter",(function(){return i})),t.d(n,"metadata",(function(){return o})),t.d(n,"toc",(function(){return u})),t.d(n,"default",(function(){return b}));var r=t(3),a=t(7),l=(t(0),t(96)),i={title:"Program Rule Engine",slug:"/program-rule-engine"},o={unversionedId:"program-rule-engine",id:"program-rule-engine",isDocsHomePage:!1,title:"Program Rule Engine",description:"RuleEngine (WIP)",source:"@site/docs/program-rule-engine.md",slug:"/program-rule-engine",permalink:"/d2-touch/docs/program-rule-engine",editUrl:"https://github.com/udsm-dhis2-lab/d2-touch/edit/develop/docs/docs/program-rule-engine.md",version:"current",sidebar:"docs",previous:{title:"Error Management",permalink:"/d2-touch/docs/error-management"},next:{title:"Program Indicator Engine",permalink:"/d2-touch/docs/program-indicator-engine"}},u=[{value:"RuleEngine (WIP)",id:"ruleengine-wip",children:[]}],c={toc:u};function b(e){var n=e.components,t=Object(a.a)(e,["components"]);return Object(l.b)("wrapper",Object(r.a)({},c,t,{components:n,mdxType:"MDXLayout"}),Object(l.b)("h3",{id:"ruleengine-wip"},"RuleEngine (WIP)"),Object(l.b)("h4",{id:"initialization"},"Initialization"),Object(l.b)("p",null,Object(l.b)("inlineCode",{parentName:"p"},"RuleEngine")," is initialized in two steps."),Object(l.b)("ul",null,Object(l.b)("li",{parentName:"ul"},"Metadata configuration within ",Object(l.b)("inlineCode",{parentName:"li"},"RuleEngineContext")),Object(l.b)("li",{parentName:"ul"},"Setting background / contextual data for ",Object(l.b)("inlineCode",{parentName:"li"},"RuleEngine"))),Object(l.b)("pre",null,Object(l.b)("code",{parentName:"pre"},"RuleEngineContext ruleEngineContext = RuleEngineContext.builder(ruleExpressionEvaluator)\n                .ruleVariables(ruleVariables)    // optional\n                .rules(rules)                    // at least one rule must be supplied\n                .build();\n")),Object(l.b)("p",null,Object(l.b)("inlineCode",{parentName:"p"},".builder")," factory method accepts instance of ",Object(l.b)("inlineCode",{parentName:"p"},"RuleExpressionEvaluator")," - something what knows how to evaluate program rule statements. ",Object(l.b)("inlineCode",{parentName:"p"},"RuleExpressionEvaluator")," implementation might be specific to certain platform. For example, on JVM it can be backed by ",Object(l.b)("a",{parentName:"p",href:"http://commons.apache.org/proper/commons-jexl/"},"JEXL"),", while on android it can be something like ",Object(l.b)("a",{parentName:"p",href:"https://github.com/square/duktape-android.git"},"duktape-android"),"."),Object(l.b)("p",null,Object(l.b)("inlineCode",{parentName:"p"},"RuleEngineContext")," instance is immutable. It means it can be safely shared and reused across multiple threads. Next step will be setting some contextual data to the rule engine, which will be used as a source of data for most variables."),Object(l.b)("pre",null,Object(l.b)("code",{parentName:"pre"},"RuleEngine ruleEngine = ruleEngineContext.toEngineBuilder()\n        .enrollment(enrollment)    // contextual enrollment\n        .events(events)            // contextual events\n        .build();\n")),Object(l.b)("p",null,Object(l.b)("inlineCode",{parentName:"p"},"RuleEngine")," is immutable as well. In example above, ",Object(l.b)("inlineCode",{parentName:"p"},"toEngineBuilder()")," method returns and instance of ",Object(l.b)("inlineCode",{parentName:"p"},"RuleEngine.Builder")," class. All parameters are optional, it means that one can simply call ",Object(l.b)("inlineCode",{parentName:"p"},"ruleEngineContext.toEngineBuilder().build()")," to get an instance of engine back."),Object(l.b)("h4",{id:"evaluation"},"Evaluation"),Object(l.b)("p",null,"Now we can send target event or enrollment to the engine in order to get some ",Object(l.b)("inlineCode",{parentName:"p"},"RuleEffect"),"s back. Before showing code, there are certain quirks which one should be aware of. You are not allowed to send duplicate events or enrollments to the engine as evaluation targets. In other words, if you have already supplied enrollment or event as a part of the contextual data, you won't be allowed to send it again as evaluation target. For example:"),Object(l.b)("pre",null,Object(l.b)("code",{parentName:"pre"},"RuleEngine ruleEngine = ruleEngineContext.toEngineBuilder()\n        .enrollment(enrollment)    // contextual enrollment        \n        .build();\n\nruleEngine.evaluate(enrollment);   // not allowed!        \n")),Object(l.b)("p",null,"In general, there are a few scenarios in which rule engine can be used. Let's use next notation to declare possible options."),Object(l.b)("p",null,Object(l.b)("inlineCode",{parentName:"p"},"<metadata>(contextual_data)[evaluation_target]")),Object(l.b)("ul",null,Object(l.b)("li",{parentName:"ul"},Object(l.b)("inlineCode",{parentName:"li"},"<rules, variables>(single_events - target_event)[target_event]"),": applicable for programs without registration."),Object(l.b)("li",{parentName:"ul"},Object(l.b)("inlineCode",{parentName:"li"},"<rules, variables>(enrollment, enrollment_events - target_event)[target_event]"),": applicable for programs with registration. In this case, event is under evaluation."),Object(l.b)("li",{parentName:"ul"},Object(l.b)("inlineCode",{parentName:"li"},"<rules, variables>(enrollment_events)[target_enrollment]"),": evaluating enrollment. In this case, events which are a part of enrollment, can be used as source of values for program rule variables.  ")),Object(l.b)("p",null,"There are two methods for evaluation at the moment:"),Object(l.b)("pre",null,Object(l.b)("code",{parentName:"pre"},"List<RuleEffect> enrollmentEffects = ruleEngine.evaluate(enrollment);\nList<RuleEffect> eventEffects = ruleEngine.evaluate(event);\n")),Object(l.b)("p",null,"List of supported environment (contextual) variables:"),Object(l.b)("ul",null,Object(l.b)("li",{parentName:"ul"},"current_date"),Object(l.b)("li",{parentName:"ul"},"event_date"),Object(l.b)("li",{parentName:"ul"},"event_count"),Object(l.b)("li",{parentName:"ul"},"due_date"),Object(l.b)("li",{parentName:"ul"},"event_id"),Object(l.b)("li",{parentName:"ul"},"enrollment_date"),Object(l.b)("li",{parentName:"ul"},"enrollment_id"),Object(l.b)("li",{parentName:"ul"},"enrollment_count"),Object(l.b)("li",{parentName:"ul"},"incident_date"),Object(l.b)("li",{parentName:"ul"},"tei_count  ")),Object(l.b)("hr",null),Object(l.b)("p",null,"WIP"))}b.isMDXComponent=!0},96:function(e,n,t){"use strict";t.d(n,"a",(function(){return p})),t.d(n,"b",(function(){return d}));var r=t(0),a=t.n(r);function l(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){l(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function u(e,n){if(null==e)return{};var t,r,a=function(e,n){if(null==e)return{};var t,r,a={},l=Object.keys(e);for(r=0;r<l.length;r++)t=l[r],n.indexOf(t)>=0||(a[t]=e[t]);return a}(e,n);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(r=0;r<l.length;r++)t=l[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}var c=a.a.createContext({}),b=function(e){var n=a.a.useContext(c),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},p=function(e){var n=b(e.components);return a.a.createElement(c.Provider,{value:n},e.children)},s={inlineCode:"code",wrapper:function(e){var n=e.children;return a.a.createElement(a.a.Fragment,{},n)}},m=a.a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,l=e.originalType,i=e.parentName,c=u(e,["components","mdxType","originalType","parentName"]),p=b(t),m=r,d=p["".concat(i,".").concat(m)]||p[m]||s[m]||l;return t?a.a.createElement(d,o(o({ref:n},c),{},{components:t})):a.a.createElement(d,o({ref:n},c))}));function d(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var l=t.length,i=new Array(l);i[0]=m;var o={};for(var u in n)hasOwnProperty.call(n,u)&&(o[u]=n[u]);o.originalType=e,o.mdxType="string"==typeof e?e:r,i[1]=o;for(var c=2;c<l;c++)i[c]=t[c];return a.a.createElement.apply(null,i)}return a.a.createElement.apply(null,t)}m.displayName="MDXCreateElement"}}]);