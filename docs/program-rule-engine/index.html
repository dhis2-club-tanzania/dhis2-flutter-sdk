<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.72">
<link rel="alternate" type="application/rss+xml" href="/d2-touch/blog/rss.xml" title="D2Touch (DHIS2 Flutter SDK) Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/d2-touch/blog/atom.xml" title="D2Touch (DHIS2 Flutter SDK) Blog Atom Feed"><title data-react-helmet="true">Program Rule Engine | D2Touch (DHIS2 Flutter SDK)</title><meta data-react-helmet="true" property="og:url" content="https://udsm-dhis2-lab.github.io/d2-touch/docs/program-rule-engine"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Program Rule Engine | D2Touch (DHIS2 Flutter SDK)"><meta data-react-helmet="true" name="description" content="RuleEngine (WIP)"><meta data-react-helmet="true" property="og:description" content="RuleEngine (WIP)"><link data-react-helmet="true" rel="shortcut icon" href="/d2-touch/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://udsm-dhis2-lab.github.io/d2-touch/docs/program-rule-engine"><link data-react-helmet="true" rel="alternate" href="https://udsm-dhis2-lab.github.io/d2-touch/docs/program-rule-engine" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://udsm-dhis2-lab.github.io/d2-touch/docs/program-rule-engine" hreflang="x-default"><link rel="stylesheet" href="/d2-touch/assets/css/styles.e760dd25.css">
<link rel="preload" href="/d2-touch/assets/js/styles.af9fa4f8.js" as="script">
<link rel="preload" href="/d2-touch/assets/js/runtime~main.55cc834a.js" as="script">
<link rel="preload" href="/d2-touch/assets/js/main.0a5d703f.js" as="script">
<link rel="preload" href="/d2-touch/assets/js/1.9e39f1ba.js" as="script">
<link rel="preload" href="/d2-touch/assets/js/2.4fae812d.js" as="script">
<link rel="preload" href="/d2-touch/assets/js/3.bde55d57.js" as="script">
<link rel="preload" href="/d2-touch/assets/js/1be78505.296c988f.js" as="script">
<link rel="preload" href="/d2-touch/assets/js/28.4f63c7f5.js" as="script">
<link rel="preload" href="/d2-touch/assets/js/935f2afb.70ae76b7.js" as="script">
<link rel="preload" href="/d2-touch/assets/js/17896441.b056f953.js" as="script">
<link rel="preload" href="/d2-touch/assets/js/03ae7d9e.11b79226.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/d2-touch/"><img src="/d2-touch/img/logo.svg" alt="D2Touch (DHIS2 Flutter SDK)" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/d2-touch/img/logo.svg" alt="D2Touch (DHIS2 Flutter SDK)" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">D2Touch (DHIS2 Flutter SDK)</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/d2-touch/docs/">Docs</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/udsm-dhis2-lab/d2-touch/tree/develop/docs/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_GrZ2"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/d2-touch/"><img src="/d2-touch/img/logo.svg" alt="D2Touch (DHIS2 Flutter SDK)" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/d2-touch/img/logo.svg" alt="D2Touch (DHIS2 Flutter SDK)" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">D2Touch (DHIS2 Flutter SDK)</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/d2-touch/docs/">Docs</a></li><li class="menu__list-item"><a href="https://github.com/udsm-dhis2-lab/d2-touch/tree/develop/docs/" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper main-docs-wrapper"><div class="docPage_31aa"><div class="docSidebarContainer_3Kbt" role="complementary"><div class="sidebar_15mo"><div class="menu menu--responsive thin-scrollbar menu_Bmed"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_fgN0" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Introduction</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/d2-touch/docs/">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/d2-touch/docs/about">About this guide</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/d2-touch/docs/getting-started">Getting Started</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Modules &amp; Repositories</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/d2-touch/docs/query-builder">Query Builder</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/d2-touch/docs/filters">Filters</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/d2-touch/docs/ordering">Ordering</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/d2-touch/docs/nested-fields">Nested Fields</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/d2-touch/docs/helpers">Helpers</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/d2-touch/docs/module-list">Module List</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Developing with SDK</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/d2-touch/docs/workflow">Workflow</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/d2-touch/docs/settings">Settings</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/d2-touch/docs/error-management">Error Management</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Engines</a><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/d2-touch/docs/program-rule-engine">Program Rule Engine</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/d2-touch/docs/program-indicator-engine">Program Indicator Engine</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/d2-touch/docs/validation-rule-engine">Validation Rule Engine</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Misc</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/d2-touch/docs/database">Database</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3ufF"><div class="container padding-vert--lg docItemWrapper_3FMP"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><header><h1 class="docTitle_3a4h">Program Rule Engine</h1></header><div class="markdown"><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="ruleengine-wip"></a>RuleEngine (WIP)<a class="hash-link" href="#ruleengine-wip" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="initialization"></a>Initialization<a class="hash-link" href="#initialization" title="Direct link to heading">#</a></h4><p><code>RuleEngine</code> is initialized in two steps.</p><ul><li>Metadata configuration within <code>RuleEngineContext</code></li><li>Setting background / contextual data for <code>RuleEngine</code></li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">RuleEngineContext ruleEngineContext = RuleEngineContext.builder(ruleExpressionEvaluator)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                .ruleVariables(ruleVariables)    // optional</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                .rules(rules)                    // at least one rule must be supplied</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                .build();</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p><code>.builder</code> factory method accepts instance of <code>RuleExpressionEvaluator</code> - something what knows how to evaluate program rule statements. <code>RuleExpressionEvaluator</code> implementation might be specific to certain platform. For example, on JVM it can be backed by <a href="http://commons.apache.org/proper/commons-jexl/" target="_blank" rel="noopener noreferrer">JEXL</a>, while on android it can be something like <a href="https://github.com/square/duktape-android.git" target="_blank" rel="noopener noreferrer">duktape-android</a>.</p><p><code>RuleEngineContext</code> instance is immutable. It means it can be safely shared and reused across multiple threads. Next step will be setting some contextual data to the rule engine, which will be used as a source of data for most variables.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">RuleEngine ruleEngine = ruleEngineContext.toEngineBuilder()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        .enrollment(enrollment)    // contextual enrollment</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        .events(events)            // contextual events</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        .build();</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p><code>RuleEngine</code> is immutable as well. In example above, <code>toEngineBuilder()</code> method returns and instance of <code>RuleEngine.Builder</code> class. All parameters are optional, it means that one can simply call <code>ruleEngineContext.toEngineBuilder().build()</code> to get an instance of engine back.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="evaluation"></a>Evaluation<a class="hash-link" href="#evaluation" title="Direct link to heading">#</a></h4><p>Now we can send target event or enrollment to the engine in order to get some <code>RuleEffect</code>s back. Before showing code, there are certain quirks which one should be aware of. You are not allowed to send duplicate events or enrollments to the engine as evaluation targets. In other words, if you have already supplied enrollment or event as a part of the contextual data, you won&#x27;t be allowed to send it again as evaluation target. For example:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">RuleEngine ruleEngine = ruleEngineContext.toEngineBuilder()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        .enrollment(enrollment)    // contextual enrollment        </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        .build();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ruleEngine.evaluate(enrollment);   // not allowed!        </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>In general, there are a few scenarios in which rule engine can be used. Let&#x27;s use next notation to declare possible options.</p><p><code>&lt;metadata&gt;(contextual_data)[evaluation_target]</code></p><ul><li><code>&lt;rules, variables&gt;(single_events - target_event)[target_event]</code>: applicable for programs without registration.</li><li><code>&lt;rules, variables&gt;(enrollment, enrollment_events - target_event)[target_event]</code>: applicable for programs with registration. In this case, event is under evaluation.</li><li><code>&lt;rules, variables&gt;(enrollment_events)[target_enrollment]</code>: evaluating enrollment. In this case, events which are a part of enrollment, can be used as source of values for program rule variables.  </li></ul><p>There are two methods for evaluation at the moment:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">List&lt;RuleEffect&gt; enrollmentEffects = ruleEngine.evaluate(enrollment);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">List&lt;RuleEffect&gt; eventEffects = ruleEngine.evaluate(event);</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>List of supported environment (contextual) variables:</p><ul><li>current_date</li><li>event_date</li><li>event_count</li><li>due_date</li><li>event_id</li><li>enrollment_date</li><li>enrollment_id</li><li>enrollment_count</li><li>incident_date</li><li>tei_count  </li></ul><hr><p>WIP</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/udsm-dhis2-lab/d2-touch/edit/develop/docs/docs/program-rule-engine.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-label="Edit page"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/d2-touch/docs/error-management"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Error Management</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/d2-touch/docs/program-indicator-engine"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Program Indicator Engine Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#ruleengine-wip" class="table-of-contents__link">RuleEngine (WIP)</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 Interactive Apps Space.</div></div></div></footer></div>
<script src="/d2-touch/assets/js/styles.af9fa4f8.js"></script>
<script src="/d2-touch/assets/js/runtime~main.55cc834a.js"></script>
<script src="/d2-touch/assets/js/main.0a5d703f.js"></script>
<script src="/d2-touch/assets/js/1.9e39f1ba.js"></script>
<script src="/d2-touch/assets/js/2.4fae812d.js"></script>
<script src="/d2-touch/assets/js/3.bde55d57.js"></script>
<script src="/d2-touch/assets/js/1be78505.296c988f.js"></script>
<script src="/d2-touch/assets/js/28.4f63c7f5.js"></script>
<script src="/d2-touch/assets/js/935f2afb.70ae76b7.js"></script>
<script src="/d2-touch/assets/js/17896441.b056f953.js"></script>
<script src="/d2-touch/assets/js/03ae7d9e.11b79226.js"></script>
</body>
</html>